<mat-card class="map-card">
  <div class="map-toolbar">
    <button mat-stroked-button (click)="zoomOut()">−</button>
    <button mat-stroked-button (click)="reset()">100%</button>
    <button mat-stroked-button (click)="zoomIn()">+</button>

    <span class="spacer"></span>
    <button mat-stroked-button color="accent" (click)="openUploadDialog()">Загрузить CSV</button>
  </div>

  <div
    class="viewport"
    #viewport
    (mousedown)="startPan($event)"
    (mousemove)="movePan($event)"
    (mouseup)="endPan()"
    (mouseleave)="endPan()"
    (touchstart)="startPan($event)"
    (touchmove)="movePan($event)"
    (touchend)="endPan()"
  >
    <svg
      [attr.width]="mapWidth"
      [attr.height]="mapHeight"
      [attr.viewBox]="[-offsetX, -offsetY, mapWidth / safeScale, mapHeight / safeScale].join(' ')"
    >
      <!-- сетка -->
      <g class="grid">
        <rect
          [attr.x]="0"
          [attr.y]="0"
          [attr.width]="mapWidth"
          [attr.height]="mapHeight"
          fill="#fff"
        />
        <g>
          <ng-container *ngFor="let c of cols; let ci = index">
            <line
              [attr.x1]="leftPad + ci * cell"
              [attr.y1]="topPad"
              [attr.x2]="leftPad + ci * cell"
              [attr.y2]="topPad + rows.length * cell"
              stroke="#eee"
            />
            <text
              [attr.x]="leftPad + ci * cell + cell / 2"
              [attr.y]="topPad - 4"
              text-anchor="middle"
              font-size="10"
              fill="#666"
            >
              {{ c }}
            </text>
          </ng-container>
          <ng-container *ngFor="let r of rows; let ri = index">
            <line
              [attr.x1]="leftPad"
              [attr.y1]="topPad + ri * cell"
              [attr.x2]="leftPad + cols.length * cell"
              [attr.y2]="topPad + ri * cell"
              stroke="#eee"
            />
            <text
              [attr.x]="leftPad - 4"
              [attr.y]="topPad + ri * cell + cell / 2 + 3"
              text-anchor="end"
              font-size="10"
              fill="#666"
            >
              {{ r }}
            </text>
          </ng-container>
          <!-- рамка -->
          <rect
            [attr.x]="leftPad"
            [attr.y]="topPad"
            [attr.width]="cols.length * cell"
            [attr.height]="rows.length * cell"
            fill="none"
            stroke="#ddd"
          />
        </g>
      </g>

      <!-- «тепловые» зоны -->
      <g class="zones">
        <rect
          *ngFor="let z of zones"
          [attr.x]="z.x"
          [attr.y]="z.y"
          [attr.width]="cell"
          [attr.height]="cell"
          [attr.fill]="zoneColor(z.level)"
          fill-opacity="0.08"
          stroke="none"
        />
      </g>

      <!-- роботы -->
      <g class="robots">
        <g
          *ngFor="let r of robots; trackBy: trackByRobotId"
          (mouseenter)="showTip($event, r)"
          (mousemove)="moveTip($event)"
          (mouseleave)="hideTip()"
        >
          <circle
            [attr.cx]="r.px"
            [attr.cy]="r.py"
            [attr.r]="r.dotR"
            [attr.fill]="robotColor(r.status)"
          />
          <text
            [attr.x]="r.px"
            [attr.y]="r.py + 3"
            text-anchor="middle"
            [attr.font-size]="fontSize(r)"
            fill="#fff"
          >
            {{ r.label || '' }}
          </text>
        </g>
      </g>
    </svg>

    <!-- тултип -->
    <div class="tip" *ngIf="tipVisible" [style.left.px]="tipX" [style.top.px]="tipY">
      <div><b>ID:</b> {{ tipRobot?.id }}</div>
      <div><b>Батарея:</b> {{ tipRobot?.battery }}%</div>
      <div><b>Статус:</b> {{ tipRobot?.status }}</div>
      <div><b>Обновлено:</b> {{ fmtUpdated(tipRobot?.updatedAt) }}</div>
      <div><b>Зона:</b> {{ tipRobot?.zone }}</div>
    </div>
  </div>
</mat-card>
