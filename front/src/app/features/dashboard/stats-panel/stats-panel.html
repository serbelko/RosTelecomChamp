<mat-card class="stats-card">
  <div class="grid">
    <!-- 4 карточки -->
    <ng-container *ngIf="metrics$ | async as m">
      <div class="kpi">
        <div class="label">Активных роботов</div>
        <div class="val">
          <b>{{ (m[0]?.value || 0) - (m[1]?.value || 0) }}</b>
          <span>/ {{ m[0]?.value || 0 }}</span>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Проверено сегодня</div>
        <div class="val">
          <b>{{ m[4]?.value || 0 }}</b>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Критических остатков</div>
        <div class="val">
          <b>{{ m[2]?.value || 0 }}</b>
        </div>
      </div>

      <div class="kpi">
        <div class="label">Средний заряд</div>
        <div class="val">
          <b>{{ m[3]?.value || 0 }}</b
          ><span>%</span>
        </div>
      </div>
    </ng-container>

    <!-- График активности -->
    <div class="chart">
      <div class="head">Активность роботов (последний час) · сканы/мин</div>

      <ng-container *ngIf="points$ | async as points; else emptyChart">
        <svg [attr.viewBox]="'0 0 640 180'" class="svg">
          <!-- ось Y и сетка -->
          <ng-container *ngIf="points.length as n">
            <ng-container *ngIf="n > 0">
              <ng-container *ngFor="let t of yTicks(points); let i = index">
                <line
                  x1="30"
                  [attr.y1]="
                    10 +
                    (140 -
                      yToPx(t, 140, yTicks(points)[0], yTicks(points)[yTicks(points).length - 1]))
                  "
                  x2="630"
                  [attr.y2]="
                    10 +
                    (140 -
                      yToPx(t, 140, yTicks(points)[0], yTicks(points)[yTicks(points).length - 1]))
                  "
                  class="grid"
                />
                <text
                  x="6"
                  [attr.y]="
                    14 +
                    (140 -
                      yToPx(t, 140, yTicks(points)[0], yTicks(points)[yTicks(points).length - 1]))
                  "
                  class="ylabel"
                >
                  {{ fmt(t) }}
                </text>
              </ng-container>

              <!-- линия -->
              <path class="line" [attr.d]="'M 30,10 ' + buildPath(points, 600, 140)" />

              <!-- подписи X -->
              <ng-container *ngFor="let xl of xLabels(points, 600)">
                <text [attr.x]="30 + xl.x" y="170" class="xlabel">{{ xl.label }}</text>
              </ng-container>
            </ng-container>
          </ng-container>
        </svg>
      </ng-container>

      <ng-template #emptyChart>
        <div class="muted">Нет данных для графика.</div>
      </ng-template>
    </div>
  </div>
</mat-card>
